# LynxPrompt Project Rules

## Project Overview
LynxPrompt is a web application that generates AI IDE configuration files (.cursorrules, CLAUDE.md, copilot-instructions.md, .windsurfrules, etc.) based on user preferences through a wizard interface. It provides a "mouse experience rather than keyboard experience" for creating AI prompts.

## Tech Stack
- **Frontend**: Next.js 15.5.x (App Router), React 19, TypeScript, Tailwind CSS, shadcn/ui
- **Backend**: Next.js API Routes
- **Databases**: Dual PostgreSQL setup with Prisma ORM
  - `lynxprompt-app`: System data (templates, platforms)
  - `lynxprompt-users`: User data (users, sessions, passkeys, user templates)
- **Authentication**: NextAuth.js (GitHub OAuth, Google OAuth, Magic Link, Passkeys/WebAuthn)
- **Testing**: Vitest, React Testing Library
- **Containerization**: Docker with multi-stage builds

## Dual Database Architecture
The app uses two separate databases with distinct Prisma clients:

```typescript
// Use prismaApp for system/application data
import { prismaApp } from "@/lib/db-app";

// Use prismaUsers for user-related data
import { prismaUsers } from "@/lib/db-users";
```

**Schema files:**
- `prisma/schema-app.prisma` → generates `@prisma/client-app`
- `prisma/schema-users.prisma` → generates `@prisma/client-users`

**Database commands:**
```bash
# Generate both clients
npm run db:generate

# Push schema changes
npm run db:push

# Seed both databases
npm run db:seed
```

## Authentication & Authorization

### User Roles
- `USER`: Default role
- `ADMIN`: Administrative access
- `SUPERADMIN`: Full system access (auto-promoted via `SUPERADMIN_EMAIL` env var)

### Passkeys (WebAuthn)
Uses `@simplewebauthn/server` and `@simplewebauthn/browser`:
```typescript
// IMPORTANT: Types come from @simplewebauthn/types, NOT @simplewebauthn/server
import { generateRegistrationOptions } from "@simplewebauthn/server";
import type { AuthenticatorTransportFuture } from "@simplewebauthn/types";
```

## Infrastructure

### Docker Registry
- **Registry**: `geiserback.mango-alpha.ts.net:5000` (Tailscale MagicDNS)
- Images built and pushed manually, NOT via GitHub Actions
- **Current version**: 0.4.0

### Portainer
- **URL**: `http://watchtower.mango-alpha.ts.net:9001`
- **Endpoint ID**: 2
- **Stack ID**: 161 (production), deployed from Gitea

### Environments
- **Production**: `gitea/watchtower/lynxprompt/docker-compose.yml` → https://lynxprompt.com (port 4990)
- **Development**: `gitea/geiserback/lynxprompt-dev/docker-compose.yml` → https://dev.lynxprompt.com (port 4991)

### Superadmin
Set `SUPERADMIN_EMAIL=dev@lynxprompt.com` in docker-compose. User is auto-promoted on first sign-in.

## Security Patterns

### Vulnerabilities to Avoid
1. **User Enumeration**: Don't reveal if email exists (use generic error messages)
2. **IDOR**: Always check ownership when accessing user resources; add `isPublic: true` for public template queries
3. **Auth Bypass**: Use `useSession()` from NextAuth, never `localStorage` for auth state
4. **XSS**: Sanitize all user input before storing (especially passkey names)
5. **Open Redirect**: Validate `callbackUrl` - only allow relative paths or same-origin URLs
6. **Rate Limit Memory Leak**: Periodically cleanup expired entries in in-memory rate limiters

### Security Headers (middleware.ts)
The middleware handles rate limiting and sets headers: CSP, HSTS, X-Frame-Options, etc.

### Secure Cookies
Production uses `__Secure-` prefix with httpOnly, sameSite, secure flags.

## Common Commands

### Build and Push Docker Image
```bash
docker build -t geiserback.mango-alpha.ts.net:5000/lynxprompt:0.4.0 .
docker push geiserback.mango-alpha.ts.net:5000/lynxprompt:0.4.0
```

### Portainer Stack Redeploy (PowerShell)
```powershell
$headers = @{ "X-API-Key" = "ptr_..."; "Content-Type" = "application/json" }
$body = @{ PullImage = $true; RepositoryAuthentication = $true; RepositoryUsername = "giteaer"; RepositoryPassword = "..." } | ConvertTo-Json
Invoke-RestMethod -Uri "http://watchtower.mango-alpha.ts.net:9001/api/stacks/161/git/redeploy?endpointId=2" -Method PUT -Headers $headers -Body $body
```

### Check Container Logs After Deploy
Always verify logs after deployment to catch runtime errors.

## Key Files
- `src/lib/db-app.ts` & `src/lib/db-users.ts`: Prisma client instances
- `src/lib/auth.ts`: NextAuth configuration with passkey support
- `src/middleware.ts`: Rate limiting & security headers
- `src/lib/data/templates.ts`: Data layer (queries both databases)
- `docs/SECURITY.md`: Security documentation

## Conventions
- License: GPL with commercial usage restricted to Sergio Fernández Rubio or heirs
- Footer attribution: "LynxPrompt by Geiser Cloud"
- Use semver for Docker tags (e.g., 0.4.0), never `:latest`
- All secrets hardcoded in Gitea docker-compose files (no env vars in Portainer)

## Known Issues
- `useSearchParams` requires Suspense boundary in client components
- Database pages need `export const dynamic = "force-dynamic"` to prevent build-time DB access
- Next.js 16+ deprecated middleware convention - stay on 15.5.x

## Owner
Sergio Fernández Rubio
